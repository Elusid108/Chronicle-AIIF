<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chronicle: Iterative Fiction Engine</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Merriweather', 'serif'],
                        display: ['Cinzel', 'serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.8s ease-out',
                        'nebula': 'nebula 10s ease infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        nebula: {
                            '0%, 100%': { backgroundPosition: '0% 50%' },
                            '50%': { backgroundPosition: '100% 50%' },
                        }
                    }
                }
            }
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.344.0"
        }
    }
    </script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* Base styles */
        body { margin: 0; background-color: #000; color: #e5e7eb; overflow: hidden; }
        
        /* Custom scrollbar to match the app's aesthetic */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #000; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #475569; }

        .nebula-loader {
            background: linear-gradient(-45deg, #0f172a, #1e1b4b, #312e81, #0f172a);
            background-size: 400% 400%;
            animation: nebula 10s ease infinite;
        }
        .nebula-pulse { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        .text-shadow-lg {
            text-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        }
        /* Blur transition */
        .blur-loading {
            filter: blur(12px) brightness(0.6);
            transition: filter 1s ease;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Settings, 
            Book, 
            Image as ImageIcon, 
            Play, 
            Send, 
            Terminal, 
            X, 
            Cpu, 
            Eye, 
            EyeOff,
            ChevronLeft,
            ChevronRight,
            BookOpen,
            Volume2,
            VolumeX,
            FileText,
            Type,
            CheckCircle,
            Flag,
            Printer,
            Download,
            Sparkles,
            Mic,
            User,
            Home,
            AlertTriangle,
            Star,
            RefreshCw,
            Key,
            Activity,
            Lock,
            Trash2,
            Clock,
            Server,
            Database,
            MapPin,
            User as UserIcon,
            Box,
            CornerDownRight,
            Bookmark,
            WifiOff,
            Radio,
            Palette
        } from 'lucide-react';

        // --- UTILITIES ---

        const pcmToWav = (value, sampleRate = 24000) => {
            const binaryString = atob(value);
            const len = binaryString.length;
            const buffer = new ArrayBuffer(len);
            const view = new Uint8Array(buffer);
            for (let i = 0; i < len; i++) {
                view[i] = binaryString.charCodeAt(i);
            }
            const rawPcmData = new Int16Array(buffer);

            // Add Silence Padding (0.5s) to prevent browser audio cutoff
            const paddingSamples = Math.floor(sampleRate * 0.5); 
            const pcmData = new Int16Array(rawPcmData.length + paddingSamples);
            pcmData.set(rawPcmData, paddingSamples);

            const wavBuffer = new ArrayBuffer(44 + pcmData.length * 2);
            const wavView = new DataView(wavBuffer);
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    wavView.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            writeString(0, 'RIFF');
            wavView.setUint32(4, 36 + pcmData.length * 2, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            wavView.setUint32(16, 16, true);
            wavView.setUint16(20, 1, true); 
            wavView.setUint16(22, 1, true); 
            wavView.setUint32(24, sampleRate, true);
            wavView.setUint32(28, sampleRate * 2, true);
            wavView.setUint16(32, 2, true);
            wavView.setUint16(34, 16, true);
            writeString(36, 'data');
            wavView.setUint32(40, pcmData.length * 2, true);
            const pcmView = new Int16Array(wavBuffer, 44);
            pcmView.set(pcmData);
            return new Blob([wavBuffer], { type: 'audio/wav' });
        };

        // Curated Voice Meta (12 Diverse Options)
        const VOICE_META = {
            // Male
            'Alnilam': { style: 'Low', gender: 'male' },
            'Fenrir': { style: 'Deep', gender: 'male' },
            'Charon': { style: 'Gravelly', gender: 'male' },
            'Puck': { style: 'Playful', gender: 'male' },
            'Zephyr': { style: 'Calm', gender: 'male' },
            'Orus': { style: 'Confident', gender: 'male' },
            // Female
            'Kore': { style: 'Soothing', gender: 'female' },
            'Aoede': { style: 'Musical', gender: 'female' },
            'Leda': { style: 'Bright', gender: 'female' },
            'Callirrhoe': { style: 'Calm', gender: 'female' },
            'Erinome': { style: 'Soft', gender: 'female' },
            'Sulafat': { style: 'Standard', gender: 'female' },
            
            'default': { style: 'Standard', gender: 'neutral' }
        };

        const getVoiceMeta = (name) => VOICE_META[name] || VOICE_META['default'];

        const voicesList = Object.keys(VOICE_META).filter(v => v !== 'default');

        // --- COMPONENTS ---

        const Button = ({ children, onClick, variant = 'primary', className = '', disabled = false, title = '' }) => {
            const baseStyle = "px-3 py-2 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed text-sm";
            const variants = {
                primary: "bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-900/20",
                secondary: "bg-black/50 hover:bg-black/80 text-white border border-white/10 backdrop-blur-sm", 
                outline: "border border-gray-600 hover:border-gray-400 text-gray-400 hover:text-white",
                ghost: "text-gray-400 hover:text-white hover:bg-gray-800/50",
                danger: "bg-red-900/50 hover:bg-red-900 text-red-200 border border-red-800"
            };
            return (
                <button onClick={onClick} disabled={disabled} className={`${baseStyle} ${variants[variant]} ${className}`} title={title}>
                    {children}
                </button>
            );
        };

        const Input = ({ value, onChange, placeholder, type = "text", className = "", onKeyDown, disabled }) => (
            <input
                type={type}
                value={value}
                onChange={onChange}
                placeholder={placeholder}
                onKeyDown={onKeyDown}
                disabled={disabled}
                className={`w-full bg-gray-900/50 border border-gray-700 rounded-lg px-4 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-all disabled:opacity-50 ${className}`}
            />
        );

        const Select = ({ value, onChange, options, label, allowCustom = false, customValue, onCustomChange }) => (
            <div className="flex flex-col gap-2">
                <label className="text-xs uppercase tracking-wider text-gray-500 font-bold">{label}</label>
                <div className="grid grid-cols-2 gap-2">
                    {options.map((opt) => (
                        <button
                            key={opt.value}
                            onClick={() => onChange(opt.value)}
                            className={`p-2 rounded-lg text-xs text-left transition-all border ${
                                value === opt.value 
                                ? 'bg-blue-900/20 border-blue-500 text-blue-200 shadow-[0_0_15px_rgba(59,130,246,0.15)]' 
                                : 'bg-gray-800 border-gray-700 text-gray-400 hover:bg-gray-700'
                            }`}
                        >
                            <div className="font-semibold">{opt.label}</div>
                        </button>
                    ))}
                    {allowCustom && (
                        <button
                            onClick={() => onChange('custom')}
                            className={`p-2 rounded-lg text-xs text-left transition-all border ${
                                value === 'custom'
                                ? 'bg-blue-900/20 border-blue-500 text-blue-200 shadow-[0_0_15px_rgba(59,130,246,0.15)]' 
                                : 'bg-gray-800 border-gray-700 text-gray-400 hover:bg-gray-700'
                            }`}
                        >
                            <div className="font-semibold">Custom...</div>
                        </button>
                    )}
                </div>
                {value === 'custom' && allowCustom && (
                    <Input 
                        value={customValue} 
                        onChange={onCustomChange} 
                        placeholder={`Describe custom ${label.toLowerCase()}...`}
                        className="mt-1 bg-blue-900/10 border-blue-500/50"
                    />
                )}
            </div>
        );

        const ApiKeyModal = ({ onSave }) => {
            const [key, setKey] = useState('');
            const [showKey, setShowKey] = useState(false);
            const [status, setStatus] = useState('idle'); // idle, validating, error

            const handleValidate = async () => {
                if (!key) return;
                setStatus('validating');
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-lite-preview-02-05:generateContent?key=${key}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: "Hello" }] }],
                            generationConfig: { maxOutputTokens: 1 }
                        })
                    });

                    if (response.ok) {
                        onSave(key);
                    } else {
                        setStatus('error');
                    }
                } catch (e) {
                    console.error("Validation error:", e);
                    setStatus('error');
                }
            };
            
            return (
                <div className="min-h-screen w-full bg-black flex flex-col items-center justify-center p-6 relative">
                     <div className="w-full max-w-md bg-gray-900 border border-gray-800 rounded-2xl p-8 shadow-2xl text-center relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-600 to-purple-600"></div>
                        <div className="p-4 bg-blue-900/20 rounded-full inline-block mb-4 border border-blue-500/30">
                            <Lock className="text-blue-400 w-8 h-8" />
                        </div>
                        <h1 className="text-2xl font-display font-bold text-white mb-2">Access Required</h1>
                        <p className="text-gray-400 text-sm mb-6">
                            To run Chronicle on GitHub Pages, please enter your Google Gemini API Key.
                        </p>
                        
                        <div className="space-y-4">
                            <div className="text-left">
                                <label className="text-xs font-bold text-gray-500 uppercase">API Key</label>
                                <div className="relative">
                                    <Input 
                                        type={showKey ? "text" : "password"} 
                                        value={key} 
                                        onChange={(e) => {
                                            setKey(e.target.value);
                                            if (status === 'error') setStatus('idle');
                                        }}
                                        placeholder="AIzaSy..." 
                                        className={`mt-1 pr-10 ${status === 'error' ? 'border-red-500 focus:border-red-500 focus:ring-red-500/20' : ''}`}
                                        onKeyDown={(e) => e.key === 'Enter' && handleValidate()}
                                    />
                                    <button 
                                        onClick={() => setShowKey(!showKey)} 
                                        className="absolute right-3 top-3.5 text-gray-500 hover:text-gray-300"
                                    >
                                        {showKey ? <EyeOff size={16}/> : <Eye size={16} />}
                                    </button>
                                </div>
                                {status === 'error' && (
                                    <p className="text-xs text-red-400 mt-2 flex items-center gap-1">
                                        <AlertTriangle size={12}/> Invalid API Key or Network Error
                                    </p>
                                )}
                            </div>
                            <Button onClick={handleValidate} disabled={!key || status === 'validating'} className="w-full py-3">
                                {status === 'validating' ? 'Verifying...' : 'Enter Simulation'}
                            </Button>
                            <p className="text-[10px] text-gray-600 mt-4">
                                Your key is saved locally in your browser and is never sent to any server other than Google's API.
                            </p>
                            <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-xs text-blue-500 hover:text-blue-400 underline block">Get a Gemini API Key</a>
                        </div>
                    </div>
                </div>
            )
        };

        // --- MAIN APPLICATION ---

        function App() {
            const [apiKey, setApiKey] = useState('');
            const [view, setView] = useState('setup');
            
            // Status State for Detailed Logging
            const [status, setStatus] = useState('');

            // Config & Prefs
            const [config, setConfig] = useState({
                setting: 'cyberpunk',
                settingCustom: '',
                style: 'pixel_art',
                styleCustom: '',
                mode: 'choice',
                narrativeModel: 'speed',
                audioModel: 'pro'
            });
            const [prefs, setPrefs] = useState({
                narrativeSize: 'text-lg', 
                uiSize: 'text-sm',
                voice: 'Alnilam', 
                autoPlay: true,
                endingLength: 5, 
            });

            // Circuit Breaker State
            const [mediaStatus, setMediaStatus] = useState({
                images: 'active', // active, backup, disabled
                audio: 'active'   // active, backup, disabled
            });

            const [favorites, setFavorites] = useState(() => {
                try { return JSON.parse(localStorage.getItem('chronicle_fav_voices') || '[]'); } catch { return []; }
            });

            const [initialContext, setInitialContext] = useState('');
            const [activePanel, setActivePanel] = useState(null); 

            const [showExportModal, setShowExportModal] = useState(false);
            const [showExitConfirm, setShowExitConfirm] = useState(false);
            const [showEndConfirm, setShowEndConfirm] = useState(false); 
            const [exportDetails, setExportDetails] = useState({ title: 'The Unnamed Chronicle', author: 'Anonymous' });

            const [history, setHistory] = useState([]); 
            const [codex, setCodex] = useState({ characters: {}, places: {}, items: {} });
            const [currentSlideIndex, setCurrentSlideIndex] = useState(0);
            const [summary, setSummary] = useState("The story has just begun.");
            const [userInput, setUserInput] = useState('');
            
            const [selectedCodexEntry, setSelectedCodexEntry] = useState(null); 

            const [isEnding, setIsEnding] = useState(false);
            const [turnsRemaining, setTurnsRemaining] = useState(null);
            const [isFinished, setIsFinished] = useState(false);

            const [loading, setLoading] = useState(false);
            const [generatingAssets, setGeneratingAssets] = useState({ image: false, audio: false }); 

            const [isPlaying, setIsPlaying] = useState(false);
            const [previewPlaying, setPreviewPlaying] = useState(false);
            const audioRef = useRef(null);
            const playingTurnRef = useRef(null); 

            const touchStart = useRef(null);
            const touchEnd = useRef(null);
            const minSwipeDistance = 50;
            const textScrollRef = useRef(null);

            // --- EFFECTS ---

            useEffect(() => {
                const storedKey = localStorage.getItem('chronicle_api_key');
                if (storedKey) setApiKey(storedKey);
                
                const savedPrefs = localStorage.getItem('chronicle_prefs');
                if (savedPrefs) {
                    try {
                        const parsed = JSON.parse(savedPrefs);
                        setPrefs(prev => ({ ...prev, ...parsed }));
                    } catch(e) { console.error("Error loading prefs", e); }
                }
            }, []);

            const handleKeySave = (key) => {
                const cleanKey = key.trim();
                localStorage.setItem('chronicle_api_key', cleanKey);
                setApiKey(cleanKey);
            };

            useEffect(() => {
                localStorage.setItem('chronicle_prefs', JSON.stringify(prefs));
            }, [prefs]);

            useEffect(() => {
                let animationFrame;
                const animateScroll = () => {
                    if (isPlaying && audioRef.current && textScrollRef.current) {
                        const { currentTime, duration } = audioRef.current;
                        if (duration > 0) {
                            const progress = currentTime / duration;
                            const scrollHeight = textScrollRef.current.scrollHeight - textScrollRef.current.clientHeight;
                            if (scrollHeight > 0) {
                                textScrollRef.current.scrollTop = scrollHeight * progress;
                            }
                        }
                        animationFrame = requestAnimationFrame(animateScroll);
                    }
                };
                if (isPlaying) animationFrame = requestAnimationFrame(animateScroll);
                else cancelAnimationFrame(animationFrame);
                return () => cancelAnimationFrame(animationFrame);
            }, [isPlaying]);

            useEffect(() => {
                if (history.length > 0) setCurrentSlideIndex(history.length - 1);
            }, [history.length]);

            useEffect(() => {
                if (textScrollRef.current) textScrollRef.current.scrollTop = 0;
            }, [currentSlideIndex, history]); 

            useEffect(() => {
                const currentTurn = history[currentSlideIndex];
                if (prefs.autoPlay && mediaStatus.audio !== 'disabled' && currentSlideIndex === history.length - 1 && currentTurn?.type === 'ai' && currentTurn.audio && !isPlaying && playingTurnRef.current !== currentTurn) {
                      handleSpeak(currentTurn);
                }
            }, [currentSlideIndex, history, prefs.autoPlay, mediaStatus.audio]);

            useEffect(() => {
                localStorage.setItem('chronicle_fav_voices', JSON.stringify(favorites));
            }, [favorites]);

            useEffect(() => {
                if (activePanel === 'settings') {
                    const timer = setTimeout(() => {
                        const el = document.getElementById(`voice-${prefs.voice}`);
                        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);
                    return () => clearTimeout(timer);
                }
            }, [activePanel, prefs.voice]);

            const togglePanel = (panelName) => {
                setActivePanel(current => current === panelName ? null : panelName);
            };

            // --- API LOGIC ---

            const callGemini = async (prompt, systemInstruction = "") => {
                const attempts = [];
                let data = null;
                // FIX: Prioritize 2.0 Flash (standard) for better instruction following on Codex updates
                const modelsToTry = ['gemini-2.0-flash', 'gemini-2.0-flash-lite-preview-02-05', 'gemini-1.5-flash'];
                
                for (const model of modelsToTry) {
                    const start = performance.now();
                    try {
                        setStatus(`Narrative: ${model}...`);
                        const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
                        const payload = {
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: systemInstruction }] },
                            generationConfig: { temperature: 0.8, maxOutputTokens: 2000, responseMimeType: "application/json" }
                        };
                        const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        if (!response.ok) throw new Error(`Status ${response.status}`);
                        const result = await response.json();
                        data = JSON.parse(result.candidates[0].content.parts[0].text);
                        attempts.push({ model, status: 'success', duration: (performance.now() - start) / 1000 });
                        break;
                    } catch (e) {
                        attempts.push({ model, status: 'failed', duration: (performance.now() - start) / 1000, error: e.message });
                        console.warn(`Model ${model} failed. Retrying...`);
                        await new Promise(r => setTimeout(r, 100));
                    }
                }
                
                if (!data) throw new Error("All text models failed");
                return { data, stats: attempts };
            };

            const generateImage = async (imagePrompt) => {
                if (mediaStatus.images === 'disabled') return { image: null, stats: [{ model: 'disabled', status: 'skipped', duration: 0 }] };

                const stylePrompt = config.style === 'custom' ? config.styleCustom : config.style;
                const fullPrompt = `Style: ${stylePrompt}. ${imagePrompt}`;
                const attempts = [];
                
                // BACKUP MODE: Skip directly to Pollinations
                if (mediaStatus.images === 'backup') {
                    try {
                        const start3 = performance.now();
                        const encodedPrompt = encodeURIComponent(fullPrompt);
                        const pollUrl = `https://image.pollinations.ai/prompt/${encodedPrompt}?width=1024&height=576&nologo=true`;
                        
                        // Preload to verify and time
                        await new Promise((resolve, reject) => {
                            const img = new Image();
                            img.onload = resolve;
                            img.onerror = () => reject(new Error("Pollinations fetch failed")); // Reject on error to catch
                            img.src = pollUrl;
                        });

                        attempts.push({ model: 'pollinations.ai', status: 'success', duration: (performance.now() - start3) / 1000 });
                        return { image: pollUrl, stats: attempts };
                    } catch (e) {
                        console.error("Backup generation failed", e);
                        // If backup fails, maybe try one more time or just fail gracefully without disabling everything immediately unless repeated.
                        // For now, let's keep it 'active' but return null so we can try again next turn? 
                        // Or if we assume it's offline, disable. Let's not disable on one network blip.
                        attempts.push({ model: 'pollinations.ai', status: 'failed', duration: 0, error: e.message });
                        return { image: null, stats: attempts };
                    }
                }

                // PRIMARY MODE: Try Google Models
                const start1 = performance.now();
                try {
                    setStatus("Visuals: imagen-4.0...");
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`;
                    const payload = { instances: [{ prompt: fullPrompt }], parameters: { sampleCount: 1, aspectRatio: "16:9" } };
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    
                    if (response.status === 429 || response.status === 403) {
                        setMediaStatus(prev => ({ ...prev, images: 'backup' }));
                        throw new Error("Quota/Permission Limit");
                    }

                    if (response.ok) {
                        const data = await response.json();
                        if (data.predictions?.[0]?.bytesBase64Encoded) {
                            attempts.push({ model: 'imagen-4.0-generate-001', status: 'success', duration: (performance.now() - start1) / 1000 });
                            return { image: `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`, stats: attempts };
                        }
                    }
                    throw new Error(`Imagen API Error: ${response.status}`);
                } catch (e) { 
                    attempts.push({ model: 'imagen-4.0-generate-001', status: 'failed', duration: (performance.now() - start1) / 1000, error: e.message });
                    console.warn("Imagen failed, trying fallback...", e);
                    
                    // Fallback to Gemini 2.0 Flash
                    const start2 = performance.now();
                    try {
                        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                        const payload = { contents: [{ parts: [{ text: fullPrompt }] }], generationConfig: { responseModalities: ["IMAGE"] } };
                        const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                        if (response.ok) {
                            const data = await response.json();
                            const part = data.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
                            if (part) {
                                attempts.push({ model: 'gemini-2.0-flash', status: 'success', duration: (performance.now() - start2) / 1000 });
                                return { image: `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`, stats: attempts };
                            }
                        }
                    } catch (e2) {
                        attempts.push({ model: 'gemini-2.0-flash', status: 'failed', duration: (performance.now() - start2) / 1000, error: e2.message });
                    }

                    // Final Fallback to Pollinations (Free) if primary failed but not via quota 
                    // (if quota, we threw error above and are in catch block of parent or next loop... wait, logic flow:
                    // If Quota error -> Throw -> catch(e) -> enters here.
                    // So we should try Pollinations here too as a last resort for THIS turn.
                    try {
                        const start3 = performance.now();
                        const encodedPrompt = encodeURIComponent(fullPrompt);
                        const pollUrl = `https://image.pollinations.ai/prompt/${encodedPrompt}?width=1024&height=576&nologo=true`;
                        
                        await new Promise((resolve, reject) => {
                            const img = new Image();
                            img.onload = resolve;
                            img.onerror = () => reject(new Error("Pollinations fetch failed"));
                            img.src = pollUrl;
                        });

                        attempts.push({ model: 'pollinations.ai', status: 'success', duration: (performance.now() - start3) / 1000 });
                        return { image: pollUrl, stats: attempts };
                    } catch (e3) {
                        attempts.push({ model: 'pollinations.ai', status: 'failed', duration: 0, error: e3.message });
                    }
                }
                return { image: null, stats: attempts };
            };

            const generateSpeech = async (text, voiceOverride = null) => {
                if (mediaStatus.audio === 'disabled' && !voiceOverride) return { audio: 'browser_tts', stats: [{ model: 'browser_tts', status: 'fallback', duration: 0 }] };
                
                if (mediaStatus.audio === 'backup') {
                    return { audio: 'browser_tts', stats: [{ model: 'browser_tts', status: 'success', duration: 0 }] };
                }

                const attempts = [];
                const currentVoice = voiceOverride || prefs.voice;
                const modelToUse = 'gemini-2.5-flash-preview-tts';
                const start = performance.now();

                try {
                    setStatus(`Audio: ${modelToUse}...`);
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelToUse}:generateContent?key=${apiKey}`;
                    const payload = {
                        contents: [{ parts: [{ text }] }],
                        generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: currentVoice } } } }
                    };

                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    
                    if (!response.ok) {
                        if (response.status === 429 || response.status === 403) {
                            if (!voiceOverride) setMediaStatus(prev => ({ ...prev, audio: 'backup' }));
                        }
                        throw new Error(`Status ${response.status}`);
                    }
                    const data = await response.json();
                    const audioData = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                    if (audioData) {
                        attempts.push({ model: modelToUse, status: 'success', duration: (performance.now() - start) / 1000 });
                        return { audio: pcmToWav(audioData), stats: attempts };
                    }
                    throw new Error("No audio data");
                } catch (e) {
                    attempts.push({ model: modelToUse, status: 'failed', duration: (performance.now() - start) / 1000, error: e.message });
                    // Explicitly log browser_tts success
                    attempts.push({ model: 'browser_tts', status: 'success', duration: 0 });
                    return { audio: 'browser_tts', stats: attempts };
                }
            };

            const clearApiKey = () => {
                if (confirm("Are you sure you want to remove your API Key?")) {
                    localStorage.removeItem('chronicle_api_key');
                    setApiKey('');
                    togglePanel(null);
                }
            };

            const resetGame = () => {
                setHistory([]);
                setCodex({ characters: {}, places: {}, items: {} });
                setCurrentSlideIndex(0);
                setSummary("The story has just begun.");
                setUserInput('');
                setIsEnding(false);
                setTurnsRemaining(null);
                setIsFinished(false);
                setLoading(false);
                setGeneratingAssets({ image: false, audio: false });
                setStatus('');
                setInitialContext(''); 
                setExportDetails({ title: 'The Unnamed Chronicle', author: 'Anonymous' });
                setMediaStatus({ images: 'active', audio: 'active' }); 
                stopAudio();
                setActivePanel(null);
            };

            const confirmExit = () => {
                if (history.length > 0 && !isFinished) setShowExitConfirm(true);
                else { resetGame(); setView('setup'); }
            };

            const updateCodexState = (updates, currentTurnIndex) => {
                if (!updates || !Array.isArray(updates)) return;
                setCodex(prev => {
                    const next = { ...prev };
                    updates.forEach(item => {
                        let catKey = item.category?.toLowerCase();
                        if (catKey === 'character') catKey = 'characters';
                        else if (catKey === 'place') catKey = 'places';
                        else if (catKey === 'item') catKey = 'items';
                        if (!next[catKey] && next[item.category?.toLowerCase() + 's']) catKey = item.category?.toLowerCase() + 's';
                        
                        if (next[catKey]) {
                            const existing = next[catKey][item.key];
                            const pageNum = currentTurnIndex + 1;
                            if (existing) {
                                let desc = typeof existing === 'string' ? existing : existing.description;
                                let cites = typeof existing === 'string' ? [] : (existing.citations || []);
                                if (!desc.includes(item.entry)) desc = `${desc}; ${item.entry}`;
                                if (!cites.includes(pageNum)) cites = [...cites, pageNum];
                                next[catKey][item.key] = { description: desc, citations: cites };
                            } else {
                                next[catKey][item.key] = { description: item.entry, citations: [pageNum] };
                            }
                        }
                    });
                    return next;
                });
            };

            const initiateEnding = () => { setShowEndConfirm(true); };
            const confirmEndingSequence = () => { setShowEndConfirm(false); setIsEnding(true); setTurnsRemaining(prefs.endingLength); };
            const resumeStory = () => {
                setIsEnding(false); setIsFinished(false); setTurnsRemaining(null);
                const lastTurn = history[history.length - 1];
                if (lastTurn && lastTurn.type !== 'chapter_marker') {
                    setHistory(prev => [...prev, { type: 'chapter_marker', title: 'New Chapter' }]);
                    setCurrentSlideIndex(prev => prev + 1);
                }
            };

            const exportBook = () => {
                const bookWindow = window.open('', '_blank');
                const showToc = history.filter(t => t.type === 'ai').length > 5;
                let pageCount = 0;
                const tocHtml = history.map((turn, i) => {
                    if (turn.type === 'ai') { pageCount++; return `<a href="#ch${i}" class="chapter-link">Page ${pageCount}</a>`; }
                    return '';
                }).join('');
                const contentHtml = history.map((turn, i) => {
                    if (turn.type === 'chapter_marker') return `<div class="chapter-marker"><h2>${turn.title}</h2><hr/></div>`;
                    if (turn.type === 'ai') return `<div id="ch${i}" class="story-turn">${turn.image ? `<img src="${turn.image}" class="turn-img" />` : ''}<div class="turn-text">${(turn.narrative || '').replace(/\n/g, '<br/>')}</div></div>`;
                    return '';
                }).join('');
                const html = `<html><head><title>${exportDetails.title}</title><style>@media print { @page { margin: 2cm; size: A4; } body { font-family: 'Georgia', serif; } } body { font-family: 'Georgia', serif; max-width: 800px; mx-auto; padding: 40px; color: #1a1a1a; line-height: 1.6; } h1, h2 { text-align: center; } .turn-img { width: 100%; max-height: 400px; object-fit: contain; margin: 2em 0; display: block; border-radius: 4px; } .turn-text { margin-bottom: 2em; text-align: justify; } .chapter-marker { margin: 4em 0; text-align: center; page-break-before: always; } .toc { margin-top: 4em; page-break-after: always; } .chapter-link { display: block; padding: 0.5em 0; border-bottom: 1px dotted #ccc; text-decoration: none; color: black; } .story-turn { page-break-inside: avoid; margin-bottom: 2em; }</style></head><body><h1 style="margin-top:40vh">${exportDetails.title}</h1><h2>by ${exportDetails.author}</h2>${showToc ? `<div class="toc"><h1>Table of Contents</h1>${tocHtml}</div>` : '<div style="margin-bottom: 4em;"></div>'}${contentHtml}<scr` + `ipt>window.onload=()=>{setTimeout(()=>window.print(),1000);}</scr` + `ipt></body></html>`;
                bookWindow.document.write(html);
                bookWindow.document.close();
            };

            const processTurn = async (promptType, inputVal) => {
                stopAudio();
                setLoading(true);
                setStatus("Initializing core systems...");
                
                let systemPrompt = getSystemPrompt();
                if (isEnding) {
                    if (turnsRemaining > 1) systemPrompt += `\nCRITICAL: ENDING. ${turnsRemaining} turns left. Wrap up. LONGER response.`;
                    else if (turnsRemaining === 1) systemPrompt += `\nCRITICAL: PENULTIMATE. Stage finale. Substantial response.`;
                    else systemPrompt += `\nCRITICAL: FINAL. Satisfying conclusion. No choices. Long response.`;
                }

                try {
                    const { data: turnData, stats: textStats } = await callGemini(inputVal, systemPrompt);
                    const newTurnIndex = history.length; 
                    updateCodexState(turnData.codex_updates, newTurnIndex);
                    setSummary(prev => prev ? prev + "\n" + turnData.summary_update : turnData.summary_update);
                    
                    const newTurn = { ...turnData, image: null, audio: null, type: 'ai', userActionPreceding: promptType === 'initial' ? null : inputVal, stats: { text: textStats, image: [], audio: [] } };
                    setHistory(prev => [...prev, newTurn]);
                    
                    if (promptType === 'initial') { setCurrentSlideIndex(0); setView('game'); } 
                    else setCurrentSlideIndex(prev => prev + 1);
                    
                    setLoading(false);
                    const fetchImage = mediaStatus.images !== 'disabled';
                    const fetchAudio = mediaStatus.audio !== 'disabled' && prefs.autoPlay;
                    setGeneratingAssets({ image: fetchImage, audio: fetchAudio });
                    setStatus("Generating assets...");

                    if (fetchImage) {
                        generateImage(turnData.image_prompt).then(imageResult => {
                            setHistory(prev => {
                                const updated = [...prev];
                                const index = updated.length - 1;
                                if (updated[index] && updated[index].narrative === newTurn.narrative) {
                                    updated[index] = { ...updated[index], image: imageResult.image, stats: { ...updated[index].stats, image: imageResult.stats } };
                                }
                                return updated;
                            });
                            setGeneratingAssets(prev => ({ ...prev, image: false }));
                        });
                    }

                    if (fetchAudio && turnData.narrative) {
                        generateSpeech(turnData.narrative).then(audioResult => {
                            setHistory(prev => {
                                const updated = [...prev];
                                const index = updated.length - 1;
                                if (updated[index] && updated[index].narrative === newTurn.narrative) {
                                    updated[index] = { ...updated[index], audio: audioResult.audio, stats: { ...updated[index].stats, audio: audioResult.stats } };
                                }
                                return updated;
                            });
                            setGeneratingAssets(prev => ({ ...prev, audio: false }));
                        });
                    }
                    
                    if (isEnding) {
                        const nextTurns = turnsRemaining - 1;
                        setTurnsRemaining(nextTurns);
                        if (nextTurns <= 0) {
                            setIsFinished(true); setTurnsRemaining(0);
                            try {
                                const { data: titleData } = await callGemini(`Book title for: "${summary}". JSON: {"title": "Title"}`, "JSON only.");
                                if (titleData.title) setExportDetails(prev => ({ ...prev, title: titleData.title }));
                            } catch(e) {}
                        }
                    }
                } catch (error) { console.error(error); alert(`Error: ${error.message}`); setLoading(false); setGeneratingAssets({image:false, audio:false}); } 
                finally { setUserInput(''); setStatus(''); }
            };

            const startGame = () => processTurn('initial', `Start story. Context: ${initialContext}`);
            const handleTurn = (input) => processTurn('continue', `User action: "${input}". Continue.`);
            const getSystemPrompt = () => {
                const settingVal = config.setting === 'custom' ? config.settingCustom : config.setting;
                const styleVal = config.style === 'custom' ? config.styleCustom : config.style;
                
                return `ROLE: AI Game Master & Loremaster. 
                GENRE: ${settingVal}
                VISUAL STYLE: ${styleVal}
                
                CURRENT CONTEXT: ${summary}
                EXISTING CODEX: ${JSON.stringify(codex)}
                
                TASK:
                1. NARRATIVE: Write the next segment in SECOND PERSON ("You..."). The player IS the protagonist.
                2. LORE SCANNING (CRITICAL): You must act as a database engine. Scan your new narrative for ANY proper names, significant locations, or unique items.
                   - If a person/place/item is mentioned that is NOT in the EXISTING CODEX, you MUST add it.
                   - If a known entity is mentioned with new details, you MUST update it.
                   - Do not be lazy. If you introduce "Captain Kael", you MUST add him to the Codex immediately.
                3. SUMMARY: concise log of this turn.
                4. VISUALS: Describe the scene for the image generator. Do NOT use names in the image prompt (the painter doesn't know who "Kael" is). Use visual descriptions ("a scar-faced soldier").

                OUTPUT JSON format:
                {"narrative": "text", "choices": ["1","2","3","4"], "summary_update": "text", "image_prompt": "visual description", "codex_updates": [{"category":"character|place|item","key":"Name","entry":"New fact or description"}]}`;
            };

            const handleSpeak = async (turn) => {
                if (!turn) return;
                if (isPlaying && playingTurnRef.current === turn) { stopAudio(); return; }
                stopAudio();
                playingTurnRef.current = turn;
                setIsPlaying(true);

                let audioContent = turn.audio;
                if (!audioContent) {
                    const result = await generateSpeech(turn.narrative || '');
                    audioContent = result.audio;
                    if (audioContent) setHistory(prev => prev.map(t => t === turn ? { ...t, audio: audioContent, stats: { ...t.stats, audio: result.stats } } : t));
                }

                if (audioContent === 'browser_tts') {
                    if ('speechSynthesis' in window) {
                        const utterance = new SpeechSynthesisUtterance("... " + (turn.narrative || ''));
                        utterance.rate = 1.0; 
                        utterance.pitch = 1.0;
                        utterance.onend = () => { setIsPlaying(false); playingTurnRef.current = null; };
                        
                        setTimeout(() => window.speechSynthesis.speak(utterance), 250);
                    } else { setIsPlaying(false); playingTurnRef.current = null; }
                } else if (audioContent) {
                    const audio = new Audio(URL.createObjectURL(audioContent));
                    audioRef.current = audio;
                    audio.play();
                    audio.onended = () => { setIsPlaying(false); playingTurnRef.current = null; };
                } else { setIsPlaying(false); playingTurnRef.current = null; }
            };

            const previewVoice = async (voiceName) => {
                stopAudio(); setPreviewPlaying(true); 
                const result = await generateSpeech("I would love to be your narrator.", voiceName);
                if (result.audio && result.audio !== 'browser_tts') {
                    const audio = new Audio(URL.createObjectURL(result.audio));
                    audioRef.current = audio;
                    audio.play();
                    audio.onended = () => setPreviewPlaying(false);
                } else { setPreviewPlaying(false); }
            };

            const stopAudio = () => { 
                if (audioRef.current) { audioRef.current.pause(); audioRef.current = null; }
                if ('speechSynthesis' in window) window.speechSynthesis.cancel();
                setIsPlaying(false); setPreviewPlaying(false); playingTurnRef.current = null;
            };
            
            const toggleFavorite = (v, e) => { e.stopPropagation(); setFavorites(p => p.includes(v) ? p.filter(x => x !== v) : [...p, v]); };
            const nextSlide = () => { if (currentSlideIndex < history.length - 1) setCurrentSlideIndex(c => c + 1); };
            const prevSlide = () => { if (currentSlideIndex > 0) setCurrentSlideIndex(c => c - 1); };
            const onTouchStart = (e) => { touchEnd.current = null; touchStart.current = e.targetTouches[0].clientX; };
            const onTouchMove = (e) => { touchEnd.current = e.targetTouches[0].clientX; };
            const onTouchEnd = () => { if (touchStart.current && touchEnd.current) (touchStart.current - touchEnd.current > minSwipeDistance) ? nextSlide() : (touchStart.current - touchEnd.current < -minSwipeDistance) && prevSlide(); };

            const currentTurnData = history[currentSlideIndex];
            
            let displayImage = currentTurnData?.image;
            let isBlurring = false;
            
            const isWaitingForImage = currentTurnData?.type === 'ai' && !currentTurnData.image && generatingAssets.image;

            if (isWaitingForImage) {
                for (let i = currentSlideIndex - 1; i >= 0; i--) {
                    if (history[i]?.image) {
                        displayImage = history[i].image;
                        isBlurring = true;
                        break;
                    }
                }
            }

            const isLatestSlide = currentSlideIndex === history.length - 1;

            if (!apiKey) return <ApiKeyModal onSave={handleKeySave} />;

            if (view === 'setup') {
                return (
                    <div className="min-h-screen w-full bg-black flex flex-col items-center justify-center p-6 text-gray-200 font-sans relative">
                        <style>{`@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&display=swap');`}</style>
                        <div className="absolute top-6 right-6 z-50">
                            <button onClick={() => togglePanel('settings')} className="p-2 bg-gray-900 rounded-lg text-gray-400 hover:text-white border border-gray-800 hover:border-blue-500/50 transition-all"><Settings size={20} /></button>
                        </div>
                        <div className="w-full max-w-2xl bg-gray-900 border border-gray-800 rounded-2xl p-8 shadow-2xl relative z-10">
                            <div className="flex items-center gap-3 mb-8"><div className="p-3 bg-blue-600 rounded-lg"><Cpu className="text-white" /></div><div><h1 className="text-3xl font-display font-bold text-white uppercase">Chronicle</h1><p className="text-gray-500 text-sm uppercase tracking-widest font-sans">Iterative Fiction Engine</p></div></div>
                            <div className="grid md:grid-cols-2 gap-6 mb-6">
                                <Select label="Genre" value={config.setting} onChange={(v) => setConfig({...config, setting: v})} allowCustom={true} customValue={config.settingCustom} onCustomChange={(e) => setConfig({...config, settingCustom: e.target.value})} options={[{ value: 'fantasy', label: 'High Fantasy' }, { value: 'cyberpunk', label: 'Cyberpunk' }, { value: 'noir', label: 'Noir Detective' }, { value: 'scifi', label: 'Space Opera' }, { value: 'lovecraft', label: 'Eldritch Horror' }, { value: 'postapoc', label: 'Wasteland' }, { value: 'steampunk', label: 'Steampunk' }, { value: 'weirdwest', label: 'Weird West' }]} />
                                <Select label="Visual Style" value={config.style} onChange={(v) => setConfig({...config, style: v})} allowCustom={true} customValue={config.styleCustom} onCustomChange={(e) => setConfig({...config, styleCustom: e.target.value})} options={[{ value: 'cinematic', label: 'Cinematic' }, { value: 'pixel_art', label: 'Pixel Art' }, { value: 'watercolor', label: 'Watercolor' }, { value: 'comic', label: 'Graphic Novel' }, { value: 'oil_painting', label: 'Oil Painting' }, { value: 'blueprint', label: 'Blueprint' }, { value: 'ukiyoe', label: 'Ukiyo-e Print' }, { value: 'synthwave', label: 'Synthwave' }]} />
                            </div>
                            <div className="mb-6"><label className="text-xs uppercase tracking-wider text-gray-500 font-bold mb-2 block font-sans">Initial Context (Optional)</label><textarea value={initialContext} onChange={(e) => setInitialContext(e.target.value)} placeholder="Waking up in a derelict cryopod..." className="w-full bg-gray-950 border border-gray-800 rounded-lg p-3 text-sm text-gray-300 focus:outline-none focus:border-blue-500 resize-none h-24 font-serif"/></div>
                            {status && <div className="mb-4 p-3 bg-blue-900/20 border border-blue-500/30 rounded flex items-center gap-2 text-xs text-blue-300 font-mono"><Activity size={14} className="animate-pulse"/> {status}</div>}
                            <Button onClick={startGame} className="w-full py-4 text-lg mt-6" disabled={loading}>{loading ? "Initializing..." : "Begin Simulation"}</Button>
                        </div>
                        {activePanel === 'settings' && renderSettings()}
                    </div>
                );
            }

            function renderSettings() {
                const sortedVoices = [...voicesList].sort((a, b) => { const aFav = favorites.includes(a); const bFav = favorites.includes(b); if (aFav && !bFav) return -1; if (!aFav && bFav) return 1; return a.localeCompare(b); });
                return (
                    <div className="absolute top-14 right-4 w-80 bg-gray-900 border border-gray-800 rounded-xl shadow-2xl z-50 p-4 overflow-y-auto max-h-[80vh] custom-scrollbar">
                        <div className="flex justify-between items-center mb-4"><h3 className="text-xs font-bold uppercase text-gray-500 flex items-center gap-2"><Settings size={12}/> Preferences</h3><button onClick={() => togglePanel(null)}><X size={14} className="text-gray-500 hover:text-white"/></button></div>
                        <div className="space-y-6">
                            <div>
                                <label className="text-[10px] text-blue-400 font-bold block mb-2 font-sans">API ACCESS</label>
                                <div className="flex items-center justify-between bg-black border border-gray-800 rounded p-2 mb-2">
                                    <span className="text-gray-500 text-xs flex items-center gap-2"><CheckCircle size={12} className="text-green-500"/> Main Key Stored</span>
                                    <button onClick={clearApiKey} className="text-red-400 text-xs hover:text-red-300 hover:underline flex items-center gap-1"><Trash2 size={10}/> Clear</button>
                                </div>
                            </div>

                            {(mediaStatus.images !== 'active' || mediaStatus.audio !== 'active') && (
                                <div className="bg-yellow-900/20 border border-yellow-500/30 rounded p-2 text-[10px] text-yellow-200 flex flex-col gap-1">
                                    <span className="font-bold flex items-center gap-1"><WifiOff size={10}/> System Status</span>
                                    {mediaStatus.images === 'backup' && <span> Image Backup (Pollinations) Active</span>}
                                    {mediaStatus.audio === 'backup' && <span> Audio Backup (Browser TTS) Active</span>}
                                    {mediaStatus.images === 'disabled' && <span className="text-red-400"> Images Disabled</span>}
                                    {mediaStatus.audio === 'disabled' && <span className="text-red-400"> Audio Disabled</span>}
                                </div>
                            )}

                            <div><label className="text-[10px] text-blue-400 font-bold block mb-2 font-sans">MODE</label><div className="flex gap-1">{['choice', 'text'].map(m => <button key={m} onClick={() => setConfig({...config, mode: m})} className={`flex-1 p-2 text-[10px] border rounded uppercase ${config.mode === m ? 'bg-blue-900 border-blue-500 text-white' : 'border-gray-700 text-gray-500'}`}>{m}</button>)}</div></div>
                            
                            {mediaStatus.audio !== 'backup' && mediaStatus.audio !== 'disabled' ? (
                                <div><label className="text-[10px] text-blue-400 font-bold block mb-2 font-sans">NARRATOR</label><div className="grid grid-cols-1 gap-2 max-h-48 overflow-y-auto custom-scrollbar border border-gray-800 rounded p-1">{sortedVoices.map(v => { const meta = getVoiceMeta(v); const isFav = favorites.includes(v); return (<div key={v} id={`voice-${v}`} onClick={() => setPrefs({...prefs, voice: v})} className={`flex items-center justify-between p-2 rounded cursor-pointer border transition-all ${prefs.voice === v ? 'bg-blue-900/30 border-blue-500' : 'hover:bg-gray-800 border-transparent'}`}><div className="flex items-center gap-3"><button onClick={(e) => { e.stopPropagation(); previewVoice(v); }} disabled={previewPlaying} className="text-gray-500 hover:text-white flex-shrink-0">{previewPlaying && prefs.voice === v ? <Volume2 size={16} className="animate-pulse text-blue-400"/> : <Play size={16} />}</button><div><div className="text-xs font-bold text-gray-300 flex items-center gap-2">{v}{isFav && <Star size={10} className="fill-yellow-500 text-yellow-500"/>}</div><div className="text-[9px] text-gray-500 uppercase tracking-wider">{meta.style}</div></div></div><button onClick={(e) => toggleFavorite(v, e)} className="p-1 hover:bg-gray-700 rounded-full transition-colors"><Star size={14} className={isFav ? "fill-yellow-500 text-yellow-500" : "text-gray-600 hover:text-gray-400"} /></button></div>); })}</div></div>
                            ) : (
                                <div><label className="text-[10px] text-blue-400 font-bold block mb-2 font-sans">NARRATOR</label><div className="p-3 bg-gray-900 border border-gray-800 rounded text-xs text-gray-500 italic">System Backup Engine Active. Voice selection unavailable.</div></div>
                            )}

                            <div className="flex justify-between items-center"><label className="text-[10px] text-blue-400 font-bold font-sans uppercase">Auto-Play</label><button onClick={() => setPrefs({...prefs, autoPlay: !prefs.autoPlay})} className={`w-8 h-4 rounded-full relative transition-colors ${prefs.autoPlay ? 'bg-blue-600' : 'bg-gray-700'}`}><div className={`absolute top-0.5 w-3 h-3 bg-white rounded-full transition-transform ${prefs.autoPlay ? 'translate-x-4' : 'translate-x-0'}`}></div></button></div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="h-screen w-full flex flex-col md:flex-row bg-black text-gray-200 font-sans" onTouchStart={onTouchStart} onTouchMove={onTouchMove} onTouchEnd={onTouchEnd}>
                    <style>{`
                        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&display=swap');
                        .font-serif { font-family: 'Merriweather', serif; }
                        .font-display { font-family: 'Cinzel', serif; }
                        .nebula-loader { background: linear-gradient(-45deg, #0f172a, #1e1b4b, #312e81, #0f172a); background-size: 400% 400%; animation: nebula 10s ease infinite; }
                        @keyframes nebula { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
                        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
                        .custom-scrollbar::-webkit-scrollbar-track { background: #000; }
                        .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
                        .nebula-pulse { animation: pulse 2s infinite; }
                        @keyframes pulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }
                        .blur-loading { filter: blur(12px) brightness(0.6); transition: filter 1s ease; }
                    `}</style>
                    
                    <div className="flex-1 flex flex-col h-full relative z-10 bg-black min-w-0">
                        <div className="h-12 border-b border-gray-800 bg-gray-950 flex items-center justify-between px-4 shrink-0 z-20 relative">
                            <div className="flex items-center gap-4"><div className="text-gray-500 text-xs font-bold tracking-widest uppercase truncate max-w-[100px] md:max-w-none">{config.setting === 'custom' ? config.settingCustom : config.setting}</div><button onClick={confirmExit} className="text-gray-500 hover:text-white p-1" title="Exit"><Home size={16} /></button></div>
                            <div className="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-xs text-gray-500 uppercase tracking-widest font-bold hidden md:block font-sans">Page {currentSlideIndex + 1} of {history.length || 1}</div>
                            <div className="flex gap-2 items-center">
                                {!isEnding && !isFinished && history.length > 0 && <button onClick={initiateEnding} className="text-xs bg-red-900/30 text-red-400 border border-red-900/50 px-3 py-1 rounded hover:bg-red-900/50 flex items-center gap-2 mr-2"><Flag size={12}/> End</button>}
                                {isEnding && !isFinished && <div className="text-xs text-red-500 font-bold tracking-widest animate-pulse mr-2">END: {turnsRemaining}</div>}
                                {isFinished && <><button onClick={resumeStory} className="text-xs bg-blue-900/30 text-blue-400 border border-blue-900/50 px-3 py-1 rounded hover:bg-blue-900/50 flex items-center gap-2 mr-2"><RefreshCw size={12}/> Resume</button><button onClick={() => setShowExportModal(true)} className="text-xs bg-emerald-900/30 text-emerald-400 border border-emerald-900/50 px-3 py-1 rounded hover:bg-emerald-900/50 flex items-center gap-2 mr-2"><Printer size={12}/> Book</button></>}
                                <button onClick={() => togglePanel('settings')} className={`p-1.5 rounded hover:bg-gray-800 ${activePanel === 'settings' ? 'text-blue-400' : 'text-gray-500'}`}><Settings size={16} /></button>
                                <button onClick={() => togglePanel('codex')} className={`p-1.5 rounded hover:bg-gray-800 ${activePanel === 'codex' ? 'text-blue-400' : 'text-gray-500'}`}><BookOpen size={16} /></button>
                                <button onClick={() => togglePanel('summary')} className={`p-1.5 rounded hover:bg-gray-800 ${activePanel === 'summary' ? 'text-blue-400' : 'text-gray-500'}`}><FileText size={16} /></button>
                            </div>
                        </div>

                        <div className="h-[40vh] md:h-[45vh] bg-black border-b border-gray-900 relative shrink-0 group overflow-hidden">
                            {currentTurnData && currentTurnData.type === 'ai' ? (
                                displayImage ? (
                                    <div className="w-full h-full relative">
                                        <img 
                                            src={displayImage} 
                                            alt="Scene" 
                                            className={`w-full h-full object-contain mx-auto bg-black ${isBlurring ? 'blur-loading' : 'animate-in fade-in'}`} 
                                        />
                                        <div className="absolute inset-0 pointer-events-none bg-[radial-gradient(circle_at_center,transparent_50%,rgba(0,0,0,0.4)_100%)]"></div>
                                        {isBlurring && (
                                            <div className="absolute inset-0 flex flex-col items-center justify-center z-10">
                                                <Palette size={32} className="text-blue-300 animate-bounce mb-2"/>
                                                <span className="text-xs text-blue-200 font-display uppercase tracking-widest text-shadow-lg">Painting...</span>
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    <div className="w-full h-full flex flex-col items-center justify-center text-blue-200 gap-4 nebula-loader relative">
                                        <Sparkles size={48} className="nebula-pulse opacity-80"/>
                                        <span className="text-xs uppercase tracking-[0.3em] font-bold opacity-80 text-shadow-lg">
                                            {mediaStatus.images === 'disabled' ? "VISUALS OFFLINE" : (generatingAssets.image ? "Manifesting Reality..." : "Constructing Visuals...")}
                                        </span>
                                    </div>
                                )
                            ) : (
                                <div className="w-full h-full flex items-center justify-center text-gray-800"><span className="animate-pulse">Waiting...</span></div>
                            )}
                            
                            <div className="absolute bottom-4 left-4 z-20"><Button variant="secondary" onClick={prevSlide} disabled={currentSlideIndex === 0} className="w-10 h-10 rounded-full !p-0 shadow-xl"><ChevronLeft size={20} /></Button></div>
                            <div className="absolute bottom-4 right-4 z-20"><Button variant="secondary" onClick={nextSlide} disabled={currentSlideIndex === history.length - 1} className="w-10 h-10 rounded-full !p-0 shadow-xl"><ChevronRight size={20} /></Button></div>
                        </div>

                        <div className="flex-1 flex flex-col min-h-0 relative">
                            {currentTurnData && currentTurnData.type === 'ai' && (
                                <>
                                    <div className="absolute top-4 right-6 z-30">
                                        <button onClick={() => handleSpeak(currentTurnData)} className={`p-3 rounded-full shadow-lg transition-all duration-300 backdrop-blur-md border ${isPlaying ? 'bg-blue-600/90 text-white border-blue-400 scale-110' : 'bg-black/60 text-gray-400 border-gray-700 hover:text-white hover:bg-black/80'} ${(generatingAssets.audio && !currentTurnData.audio) || mediaStatus.audio === 'disabled' ? 'opacity-50 cursor-not-allowed' : ''}`} disabled={(generatingAssets.audio && !currentTurnData.audio) || mediaStatus.audio === 'disabled'}>
                                            {isPlaying ? <VolumeX size={20} /> : <Volume2 size={20} />}
                                        </button>
                                    </div>
                                    <div ref={textScrollRef} className="flex-1 overflow-y-auto bg-black p-6 md:p-8 custom-scrollbar">
                                        <div className="max-w-3xl mx-auto flex flex-col items-center text-center">
                                            <div className="prose prose-invert prose-p:text-gray-300 prose-p:font-serif prose-p:leading-loose w-full">
                                                {(currentTurnData.narrative || '').split('\n').map((line, i) => <p key={i} className={`mb-4 leading-relaxed text-gray-300 font-serif ${prefs.narrativeSize}`}>{line}</p>)}
                                            </div>
                                        </div>
                                    </div>
                                </>
                            )}
                            {currentTurnData && currentTurnData.type === 'chapter_marker' && (
                                <div className="flex-1 flex flex-col items-center justify-center bg-black p-8">
                                    <div className="text-center animate-in fade-in zoom-in duration-700">
                                        <div className="inline-block p-4 rounded-full border border-blue-900/30 bg-blue-900/10 mb-4"><Bookmark size={32} className="text-blue-500" /></div>
                                        <h2 className="text-3xl font-display font-bold text-white mb-2 tracking-widest">{currentTurnData.title}</h2>
                                        <p className="text-gray-500 font-serif italic">The journey continues...</p>
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="shrink-0 bg-black border-t border-gray-900 p-4 md:p-6 z-20 relative"><div className="max-w-3xl mx-auto w-full">
                            {isLatestSlide && !loading && !isFinished && currentTurnData?.type === 'ai' && (
                                <div className="animate-in fade-in slide-in-from-bottom-2">
                                {config.mode === 'choice' && currentTurnData?.choices?.length > 0 && <div className="grid grid-cols-2 gap-3">{currentTurnData.choices.slice(0,4).map((choice, i) => <button key={i} onClick={() => handleTurn(choice)} className={`p-4 text-center bg-gray-900 hover:bg-gray-800 border border-gray-800 hover:border-blue-500/50 rounded-lg text-gray-300 transition-all group h-full flex items-center justify-center font-sans ${prefs.uiSize}`}><span className="font-bold text-blue-500 mr-2">{i + 1}.</span> {choice}</button>)}</div>}
                                {config.mode === 'text' && <div className="flex gap-2"><Input value={userInput} onChange={(e) => setUserInput(e.target.value)} placeholder="What do you do next?" onKeyDown={(e) => e.key === 'Enter' && userInput && handleTurn(userInput)} disabled={loading} /><Button onClick={() => handleTurn(userInput)} disabled={!userInput || loading} className="shrink-0"><Send size={14} /></Button></div>}
                            </div>)}
                            
                            {isLatestSlide && !loading && !isFinished && currentTurnData?.type === 'chapter_marker' && (
                                <div className="flex justify-center animate-in fade-in slide-in-from-bottom-2">
                                    <Button onClick={() => handleTurn("Continue the journey.")} className="px-8 py-3 text-lg">Begin Next Chapter</Button>
                                </div>
                            )}
                            
                            {loading && <div className="text-center text-xs text-blue-400 font-mono animate-pulse">{status}</div>}
                            
                            {!loading && (generatingAssets.image || generatingAssets.audio) && (
                                <div className="text-center text-xs text-blue-400/50 italic animate-pulse font-sans font-mono">
                                    {generatingAssets.image && generatingAssets.audio ? "Generating Image & Audio..." : generatingAssets.image ? "Generating Image..." : "Synthesizing Audio..."}
                                </div>
                            )}
                            
                            {!isLatestSlide && (
                                <div className="flex justify-center"><button onClick={() => setCurrentSlideIndex(history.length - 1)} className="text-xs bg-gray-900 hover:bg-gray-800 text-blue-400 border border-blue-900/50 px-4 py-2 rounded-full flex items-center gap-2 transition-all shadow-lg hover:shadow-blue-900/20"><CornerDownRight size={14}/> Jump to Present</button></div>
                            )}
                            {isFinished && <div className="text-center text-sm text-blue-400 font-bold uppercase tracking-widest font-sans">Simulation Complete</div>}
                        </div></div>

                        {activePanel === 'settings' && renderSettings()}
                        
                        {showExportModal && <div className="absolute inset-0 bg-black/90 flex items-center justify-center z-50 p-6"><div className="w-full max-w-md bg-gray-900 border border-gray-800 rounded-xl p-6 shadow-2xl"><div className="flex justify-between items-center mb-6"><h3 className="text-lg font-bold text-white flex items-center gap-2"><Book size={20}/> Finalize Chronicle</h3><button onClick={() => setShowExportModal(false)}><X size={20} className="text-gray-500 hover:text-white"/></button></div><div className="space-y-4 mb-6"><div><label className="text-xs uppercase text-blue-400 font-bold block mb-2 font-sans">Book Title</label><Input value={exportDetails.title} onChange={e => setExportDetails({...exportDetails, title: e.target.value})} className="bg-black/50" /></div><div><label className="text-xs uppercase text-blue-400 font-bold block mb-2 font-sans">Author Name</label><Input value={exportDetails.author} onChange={e => setExportDetails({...exportDetails, author: e.target.value})} className="bg-black/50" /></div></div><Button onClick={() => { setShowExportModal(false); exportBook(); }} className="w-full py-3 text-base"><Download size={18}/> Generate PDF Document</Button></div></div>}
                        {showExitConfirm && <div className="absolute inset-0 bg-black/90 flex items-center justify-center z-50 p-6"><div className="w-full max-w-sm bg-gray-900 border border-red-900/50 rounded-xl p-6 text-center"><AlertTriangle size={32} className="text-red-500 mx-auto mb-4"/><h3 className="text-lg font-bold text-white mb-2">Abandon Simulation?</h3><p className="text-gray-400 text-sm mb-6">Your current narrative path will be lost.</p><div className="flex gap-3 justify-center"><Button onClick={()=>setShowExitConfirm(false)} variant="secondary">Cancel</Button><Button onClick={()=>{setShowExitConfirm(false); resetGame(); setView('setup');}} variant="danger">Abandon Path</Button></div></div></div>}
                        {showEndConfirm && (<div className="absolute inset-0 bg-black/90 flex items-center justify-center z-50 p-6"><div className="w-full max-w-sm bg-gray-900 border border-blue-900/50 rounded-xl p-6 text-center shadow-2xl"><Flag size={32} className="text-blue-500 mx-auto mb-4"/><h3 className="text-lg font-bold text-white mb-2">Initiate Finale?</h3><p className="text-gray-400 text-sm mb-6">The story will conclude in <span className="font-bold text-white">{prefs.endingLength} turns</span>. Make them count.</p><div className="flex gap-3 justify-center"><Button onClick={() => setShowEndConfirm(false)} variant="secondary">Cancel</Button><Button onClick={confirmEndingSequence} className="bg-blue-600 hover:bg-blue-500">Begin Ending</Button></div></div></div>)}
                        {selectedCodexEntry && (<div className="absolute inset-0 bg-black/80 flex items-center justify-center z-[60] p-6 backdrop-blur-sm" onClick={() => setSelectedCodexEntry(null)}><div className="w-full max-w-md bg-gray-900 border border-gray-700 rounded-xl p-6 shadow-2xl relative" onClick={e => e.stopPropagation()}><button onClick={() => setSelectedCodexEntry(null)} className="absolute top-4 right-4 text-gray-500 hover:text-white"><X size={20}/></button><div className="flex items-center gap-3 mb-4 text-blue-400">{selectedCodexEntry.category === 'characters' && <UserIcon size={24}/>}{selectedCodexEntry.category === 'places' && <MapPin size={24}/>}{selectedCodexEntry.category === 'items' && <Box size={24}/>}<h3 className="text-xl font-bold text-white font-display uppercase tracking-wider">{selectedCodexEntry.title}</h3></div><div className="text-sm text-gray-300 leading-relaxed font-serif mb-6 border-l-2 border-blue-900 pl-4">{selectedCodexEntry.data.description}</div><div className="bg-black/50 rounded p-3 border border-gray-800"><h4 className="text-[10px] uppercase font-bold text-gray-500 mb-2 flex items-center gap-2"><Book size={10}/> Referenced on Pages</h4><div className="flex flex-wrap gap-2">{selectedCodexEntry.data.citations.map(pageNum => (<button key={pageNum} onClick={() => { setCurrentSlideIndex(pageNum - 1); setSelectedCodexEntry(null); togglePanel(null); }} className="text-xs bg-blue-900/30 hover:bg-blue-800 text-blue-300 px-2 py-1 rounded transition-colors border border-blue-900/50">Page {pageNum}</button>))}</div></div></div></div>)}
                        {(activePanel === 'summary' || activePanel === 'codex') && <div className="absolute top-12 bottom-0 right-0 w-full md:w-80 bg-gray-950 border-l border-gray-800 shadow-2xl z-50 flex flex-col"><div className="flex items-center justify-between p-3 border-b border-gray-800 bg-gray-900"><h3 className="text-xs font-bold uppercase tracking-widest text-gray-300 flex items-center gap-2">{activePanel === 'codex' ? <><BookOpen size={14} /> Codex</> : <><FileText size={14} /> Summary</>}</h3><button onClick={() => togglePanel(null)} className="text-gray-500 hover:text-white"><X size={16} /></button></div><div className="flex-1 overflow-y-auto p-4 custom-scrollbar">{activePanel === 'codex' ? <div className="space-y-6">{['people', 'places', 'items'].map((type, i) => { const colors = [{ title: 'People', bg: 'bg-blue-900/30', text: 'text-blue-400', key: 'characters' }, { title: 'Locations', bg: 'bg-emerald-900/30', text: 'text-emerald-400', key: 'places' }, { title: 'Artifacts', bg: 'bg-amber-900/30', text: 'text-amber-400', key: 'items' }][i]; const entries = codex[colors.key] || {}; return (<div key={type}><h4 className={`text-[10px] font-bold uppercase mb-2 flex items-center gap-2 ${colors.text}`}>{colors.title} <span className={`${colors.bg} px-1.5 py-0.5 rounded text-[9px]`}>{Object.keys(entries).length}</span></h4><div className="space-y-1.5">{Object.entries(entries).length === 0 && <p className="text-[10px] text-gray-600 italic">No records yet.</p>}{Object.entries(entries).map(([name, data]) => <div key={name} onClick={() => setSelectedCodexEntry({ title: name, data: data, category: colors.key })} className="bg-gray-900/50 p-2 rounded border border-gray-800/50 hover:border-blue-900/50 hover:bg-gray-900 transition-all cursor-pointer group"><div className="text-xs font-bold text-gray-300 group-hover:text-blue-300 transition-colors flex justify-between">{name} <CornerDownRight size={10} className="opacity-0 group-hover:opacity-100 text-blue-500"/></div><div className="text-[10px] text-gray-500 mt-0.5 leading-snug line-clamp-2">{typeof data === 'string' ? data : data.description}</div></div>)}</div></div>); })}</div> : <div className="space-y-4"><div className="bg-gray-900/50 rounded border border-gray-800 p-3"><h4 className="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2 flex items-center gap-2"><Clock size={12}/> Running Log</h4><div className="text-[10px] text-gray-400 leading-relaxed font-mono whitespace-pre-wrap">{summary}</div></div>{currentTurnData && currentTurnData.image_prompt && (<div className="bg-blue-900/10 rounded border border-blue-900/30 p-3"><h4 className="text-[10px] font-bold text-blue-400 uppercase tracking-widest mb-2 flex items-center gap-2"><ImageIcon size={12}/> Visual Directive</h4><div className="text-[10px] text-blue-300 leading-snug font-serif italic">"{currentTurnData.image_prompt}"</div></div>)}<h4 className="text-[10px] font-bold text-gray-500 uppercase tracking-widest mt-6 mb-2 border-t border-gray-800 pt-4 flex items-center gap-2"><Activity size={12}/> Performance Logs</h4><div className="space-y-3">{history.length === 0 && <p className="text-[10px] text-gray-600 italic">No logs available.</p>}{history.slice().reverse().map((turn, i) => (<div key={i} className="bg-gray-900/50 p-2 rounded border border-gray-800/50"><div className="flex justify-between items-center mb-2"><span className="text-[10px] text-blue-400 font-bold uppercase">Turn {history.length - i}</span></div>{turn.stats && (<div className="space-y-2">{[{ label: 'Narrative', icon: <Server size={10}/>, data: turn.stats.text },{ label: 'Visuals', icon: <ImageIcon size={10}/>, data: turn.stats.image },{ label: 'Voice', icon: <Mic size={10}/>, data: turn.stats.audio }].map((category, j) => (category.data && category.data.length > 0 && (<div key={j} className="text-[9px]"><div className="flex items-center gap-1 text-gray-500 mb-1 font-bold">{category.icon} {category.label}</div>{category.data.map((attempt, k) => (<div key={k} className="flex justify-between items-center pl-3 py-0.5 border-l border-gray-800 ml-1"><span className={`truncate max-w-[120px] ${attempt.status === 'success' ? 'text-gray-300' : 'text-red-400 line-through'}`}>{attempt.model}</span><div className="flex items-center gap-2"><span className="text-gray-600 font-mono">{attempt.duration.toFixed(2)}s</span>{attempt.status === 'success' ? <CheckCircle size={8} className="text-emerald-500"/> : <X size={8} className="text-red-500"/>}</div></div>))}</div>)))}</div>)}</div>))}</div></div>}</div></div>}
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>